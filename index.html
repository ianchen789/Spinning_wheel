<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生日轉轉樂</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            overflow-x: hidden;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.2em;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            width: 100%;
            max-width: 1200px;
        }

        .panel {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            flex: 1 1 300px;
            min-width: 280px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            position: relative;
        }

        .panel h2 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .wheel-panel {
            flex: 1 1 400px;
            min-width: 350px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        #wheelCanvas {
            width: 100%;
            max-width: 400px;
            height: auto;
            aspect-ratio: 1 / 1;
            border: 5px solid #3498db;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            background-color: #ecf0f1;
            transform: rotate(0deg);
        }

        .spin-button {
            margin-top: 20px;
            padding: 12px 25px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            background-color: #28a745;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .spin-button:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }

        .spin-button:active {
            background-color: #1e7e34;
            transform: translateY(0);
        }

        .spin-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .entry-list {
            margin-top: 15px;
            width: 100%;
        }

        .entry-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            background-color: #f9f9f9;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #eee;
            gap: 8px;
            font-size: 0.95em;
        }

        .entry-item label {
            min-width: 35px;
            font-weight: bold;
            color: #555;
            white-space: nowrap;
        }

        /* 調整輸入數值和文字框大小 */
        .entry-item input[type="number"] {
            width: 45px; /* 設置一個固定的較小寬度 */
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
            box-sizing: border-box; /* 確保 padding 不會增加總寬度 */
        }

        .entry-item input[type="text"] {
            flex: 1; /* 佔據剩餘所有空間 */
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 5px;
            min-width: 80px; /* 確保在小螢幕下文字框不至於太小 */
            box-sizing: border-box;
        }

        .entry-item button {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            white-space: nowrap; /* 防止刪除按鈕文字換行 */
        }

        .entry-item button:hover {
            background-color: #c0392b;
        }

        .add-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s ease;
            width: 100%;
        }

        .add-button:hover {
            background-color: #2980b9;
        }

        /* 指針樣式 */
        .pointer {
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-top: 25px solid #e74c3c;
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }

        .settings-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .settings-item {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
        }

        .settings-item label {
            font-weight: bold;
            color: #555;
            min-width: 70px;
        }

        .settings-item input[type="number"] {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 80px;
        }

        /* 彩帶動畫 */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 9999;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: red;
            animation: confetti-fall 3s forwards ease-out;
            opacity: 0;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotateZ(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotateZ(720deg);
                opacity: 0;
            }
        }

        /* 轉盤動畫的CSS */
        #wheelCanvas.spinning {
            transition: transform var(--spin-duration) cubic-bezier(0.1, 0.5, 0, 1);
            transform: rotate(var(--end-rotation));
        }
        
        /* 彈出結果視窗 */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            text-align: center;
            position: relative;
            max-width: 90%;
            transform: scale(0.8);
            opacity: 0;
            animation: modal-fade-in 0.3s forwards ease-out;
        }

        @keyframes modal-fade-in {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
        }

        .modal-title {
            font-size: 2.5em;
            color: #28a745;
            margin-bottom: 15px;
        }

        .modal-result-text {
            font-size: 3.5em;
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 25px;
            word-wrap: break-word;
            max-width: 100%;
        }

        .modal-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .modal-button:hover {
            background-color: #2980b9;
        }
        
        /* 卡片面板 */
        .card-panel {
            flex: 1 1 300px;
            min-width: 280px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }

        .card-panel .reset-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: #607d8b;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        .card-panel .reset-button:hover {
            background-color: #455a64;
        }

        .card-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }

        .card-item {
            background-color: #e8f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .card-item h3 {
            color: #2e7d32;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .card-item p {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 15px;
        }

        .card-use-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        .card-use-button:hover {
            background-color: #43A047;
        }

        .card-use-button:disabled {
            background-color: #b0c9b0;
            cursor: not-allowed;
            color: #666;
        }

        .card-item span {
            font-weight: bold;
            color: #00796b;
        }

        /* 卡片操作選擇器 */
        .card-selection-modal {
            background-color: #e0f7fa;
            border: 1px solid #b2ebf2;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
        }
        .card-selection-modal h4 {
            color: #00796b;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .card-selection-modal select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #b2ebf2;
            border-radius: 5px;
        }
        .card-selection-modal button {
            background-color: #00bcd4;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: background-color 0.3s ease;
        }
        .card-selection-modal button:hover {
            background-color: #0097a7;
        }


        /* 媒體查詢：針對小螢幕設備進一步調整 */
        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
                margin-bottom: 20px;
            }
            .container {
                flex-direction: column;
                gap: 15px;
            }
            .panel {
                padding: 15px;
                flex: 1 1 auto;
                max-height: none;
                overflow-y: visible;
            }
            .wheel-panel {
                min-width: 280px;
            }
            #wheelCanvas {
                max-width: 300px;
            }
            .spin-button {
                padding: 10px 20px;
                font-size: 16px;
            }
            .entry-item {
                font-size: 0.9em;
                padding: 6px 10px;
            }
            .entry-item input[type="number"] {
                width: 40px; /* 在小螢幕下進一步縮小 */
            }
            .entry-item input[type="text"] {
                min-width: 60px; /* 在小螢幕下也確保可讀性 */
            }
            .pointer {
                border-left: 10px solid transparent;
                border-right: 10px solid transparent;
                border-top: 20px solid #e74c3c;
                top: 10px;
            }
            .modal-content {
                padding: 25px;
            }
            .modal-title {
                font-size: 2em;
            }
            .modal-result-text {
                font-size: 3em;
            }
            .card-panel {
                max-height: none;
                overflow-y: visible;
                margin-top: 15px;
            }
            .card-item h3 {
                font-size: 1.2em;
            }
            .card-item p {
                font-size: 0.85em;
            }
            .card-use-button {
                padding: 6px 12px;
                font-size: 0.85em;
            }
             .card-panel .reset-button {
                top: 10px;
                right: 10px;
                padding: 6px 10px;
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>

    <h1>生日轉轉樂</h1>

    <div class="container">
        <div class="panel controls-panel">
            <h2>轉盤區域設定</h2>
            <div id="entries" class="entry-list">
                </div>
            <button class="add-button" onclick="addEntry()">+ 新增區域</button>

            <div class="settings-section">
                <h2>額外設定</h2>
                <div class="settings-item">
                    <label for="spinCount">旋轉圈數:</label>
                    <input type="number" id="spinCount" value="5" min="1">
                </div>
                <div class="settings-item">
                    <label for="spinDuration">旋轉時間 (秒):</label>
                    <input type="number" id="spinDuration" value="5" min="1" step="0.5">
                </div>
            </div>
        </div>

        <div class="panel wheel-panel">
            <div style="position: relative;">
                <canvas id="wheelCanvas" width="500" height="500"></canvas>
                <div class="pointer"></div>
            </div>
            <button class="spin-button" id="spinButton">旋轉！</button>
        </div>

        <div class="panel card-panel">
            <h2>功能卡片夾</h2>
            <button class="reset-button" onclick="resetCards()">重置卡片</button>
            <div class="card-list">
                <div class="card-item" id="respinCard">
                    <h3>🔄 重啟轉動卡</h3>
                    <p>轉盤停下後，再轉一次！</p>
                    <button class="card-use-button" onclick="useRespinCard()">使用 (<span id="respinCardCount">1</span>)</button>
                </div>
                <div class="card-item" id="boostCard">
                    <h3>📈 機率提升卡</h3>
                    <p>暫時增加指定區域的機率。</p>
                    <button class="card-use-button" onclick="useBoostCard()">使用 (<span id="boostCardCount">1</span>)</button>
                </div>
                <div class="card-item" id="removeCard">
                    <h3>❌ 刪除區塊卡</h3>
                    <p>暫時移除一個指定區塊。</p>
                    <button class="card-use-button" onclick="useRemoveCard()">使用 (<span id="removeCardCount">1</span>)</button>
                </div>
            </div>
            <div class="card-selection-modal" id="boostTargetSelection" style="display: none;">
                <h4>選擇提升機率的區域:</h4>
                <select id="boostTargetSelect"></select>
                <button onclick="applyBoost()">確認提升</button>
                <button onclick="cancelBoost()">取消</button>
            </div>
            <div class="card-selection-modal" id="removeTargetSelection" style="display: none;">
                <h4>選擇要移除的區域:</h4>
                <select id="removeTargetSelect"></select>
                <button onclick="applyRemove()">確認移除</button>
                <button onclick="cancelRemove()">取消</button>
            </div>
        </div>
        </div>

    <div class="confetti-container" id="confettiContainer"></div>

    <div id="resultModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <div class="modal-title">恭喜您！</div>
            <div id="finalResultText" class="modal-result-text"></div>
            <button class="modal-button" id="modalConfirmButton" onclick="closeModal()">確認</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        let centerX, centerY, radius;

        function setCanvasDimensions() {
            const canvasWidth = canvas.clientWidth;
            const canvasHeight = canvas.clientHeight;

            if (canvas.width !== canvasWidth || canvas.height !== canvasHeight) {
                canvas.width = canvasWidth;
                canvas.height = canvasHeight;
            }
            
            centerX = canvas.width / 2;
            centerY = canvas.height / 2;
            radius = Math.min(centerX, centerY) * 0.8;
        }

        const entriesContainer = document.getElementById('entries');
        const spinButton = document.getElementById('spinButton');
        const spinCountInput = document.getElementById('spinCount');
        const spinDurationInput = document.getElementById('spinDuration');
        const confettiContainer = document.getElementById('confettiContainer');
        const resultModal = document.getElementById('resultModal');
        const finalResultText = document.getElementById('finalResultText');

        // === 卡片相關 DOM 元素引用 ===
        const respinCardCountSpan = document.getElementById('respinCardCount');
        const boostCardCountSpan = document.getElementById('boostCardCount');
        const removeCardCountSpan = document.getElementById('removeCardCount');
        
        const boostTargetSelectionDiv = document.getElementById('boostTargetSelection');
        const boostTargetSelect = document.getElementById('boostTargetSelect');
        
        const removeTargetSelectionDiv = document.getElementById('removeTargetSelection');
        const removeTargetSelect = document.getElementById('removeTargetSelect');

        const modalConfirmButton = document.getElementById('modalConfirmButton'); 

        // 儲存原始的 entries 狀態，以便在卡片效果結束後恢復
        let originalEntriesState = [];

        let cards = {
            respin: { count: 1, inUse: false },
            boost: { count: 1, inUse: false, boostedEntryId: null, originalBoostedValue: 0 }, 
            remove: { count: 1, inUse: false, removedEntryId: null, originalRemovedValue: 0 } 
        };

        let entries = []; 
        let isSpinning = false;
        let lastHighlightedSliceIndex = -1;
        let currentRotationOffset = 0; 

        const colors = [
            '#FF6347', '#4682B4', '#3CB371', '#FFD700', '#DA70D6',
            '#FFA07A', '#6A5ACD', '#7FFFD4', '#CD5C5C', '#F08080',
            '#87CEFA', '#90EE90', '#FFB6C1', '#DDA0DD', '#FFE4B5',
            '#ADD8E6', '#98FB98', '#FFC0CB', '#808000', '#A52A2A'
        ];

        function addEntry(defaultText = '', defaultValue = 10) {
            const index = entries.length;
            const newEntry = {
                value: defaultValue,
                text: defaultText,
                id: `entry-${Date.now()}-${index}`
            };
            entries.push(newEntry);
            saveOriginalEntriesState(); // 每次新增或刪除時更新原始狀態
            renderEntry(newEntry);
            drawWheel();
            updateCardTargetSelects(); // 統一更新卡片相關的選擇列表
        }

        function renderEntry(entry) {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'entry-item';
            entryDiv.id = entry.id;

            entryDiv.innerHTML = `
                <label>數值:</label>
                <input type="number" min="1" value="${entry.value}" onchange="updateEntry('${entry.id}', 'value', this.value)">
                <label>文字:</label>
                <input type="text" value="${entry.text}" onchange="updateEntry('${entry.id}', 'text', this.value)">
                <button onclick="removeEntry('${entry.id}')">刪除</button>
            `;
            entriesContainer.appendChild(entryDiv);
        }

        function updateEntry(id, type, value) {
            const entryIndex = entries.findIndex(e => e.id === id);
            if (entryIndex > -1) {
                if (type === 'value') {
                    entries[entryIndex].value = Math.max(1, parseInt(value) || 1);
                } else if (type === 'text') {
                    entries[entryIndex].text = value;
                }
                saveOriginalEntriesState(); // 每次更新時更新原始狀態
                drawWheel();
                updateCardTargetSelects();
            }
        }

        function removeEntry(id) {
            if (entries.length <= 1) {
                alert("至少需要保留一個轉盤區域！");
                return;
            }
            entries = entries.filter(e => e.id !== id);
            document.getElementById(id).remove();
            saveOriginalEntriesState(); // 每次新增或刪除時更新原始狀態
            drawWheel();
            updateCardTargetSelects();
        }

        // 繪製轉盤，只考慮有效（value > 0）的區域
        function drawWheel(highlightIndex = -1) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const activeEntries = entries.filter(entry => entry.value > 0);
            const totalValue = activeEntries.reduce((sum, entry) => sum + entry.value, 0);

            if (totalValue === 0) {
                // 如果沒有有效區域，可以顯示一個提示或保持空白
                ctx.fillStyle = '#ccc';
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.textAlign = "center";
                ctx.fillStyle = "#666";
                ctx.font = `bold ${radius * 0.1}px Arial`;
                ctx.fillText("無可選區域", centerX, centerY);
                return;
            }

            let currentAngleRad = -0.5 * Math.PI; 

            activeEntries.forEach((entry, i) => {
                const angleRad = (entry.value / totalValue) * Math.PI * 2; 
                const color = colors[i % colors.length];

                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngleRad, currentAngleRad + angleRad);
                ctx.closePath();
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();

                // 判斷是否需要高亮的是這個實際繪製的區塊
                const originalIndex = entries.findIndex(e => e.id === entry.id);
                if (originalIndex === highlightIndex) {
                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, currentAngleRad, currentAngleRad + angleRad);
                    ctx.closePath();
                    ctx.strokeStyle = 'gold';
                    ctx.lineWidth = 8;
                    ctx.stroke();
                    ctx.restore();
                }

                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(currentAngleRad + angleRad / 2 + Math.PI / 2); 
                
                ctx.textAlign = "center"; 
                ctx.fillStyle = "white";

                let baseFontSize = radius * 0.08;
                let fontSize = Math.min(baseFontSize, 20);

                ctx.font = `bold ${fontSize}px Arial`;
                let textWidth = ctx.measureText(entry.text).width;
                const maxTextLength = radius * 0.6; 
                while (textWidth > maxTextLength && fontSize > (radius * 0.03)) {
                    fontSize--;
                    ctx.font = `bold ${fontSize}px Arial`;
                    textWidth = ctx.measureText(entry.text).width;
                }
                ctx.fillText(entry.text, 0, -radius * 0.7); 
                ctx.restore();

                currentAngleRad += angleRad; 
            });
        }

        function spinWheel() {
            if (isSpinning) return;

            // 只考慮 value > 0 的 activeEntries 來進行抽獎
            const activeEntries = entries.filter(entry => entry.value > 0);
            const totalValueActive = activeEntries.reduce((sum, entry) => sum + entry.value, 0);

            if (totalValueActive === 0) {
                alert("沒有可供抽獎的區域！請檢查轉盤區域設定。");
                return;
            }

            isSpinning = true;
            spinButton.disabled = true;
            removeHighlight();
            closeModal();
            
            const spinCount = parseInt(spinCountInput.value) || 5;
            const spinDuration = parseFloat(spinDurationInput.value) || 5;

            const segmentAnglesDegrees = []; 
            let cumulativeAngle = 0; 
            const sectorData = []; 

            activeEntries.forEach((entry, i) => {
                const angle = (entry.value / totalValueActive) * 360; 
                const startAngle = cumulativeAngle;
                const endAngle = cumulativeAngle + angle;
                sectorData.push({ start: startAngle, end: endAngle, originalEntryId: entry.id }); // 儲存原始 entry 的 ID
                segmentAnglesDegrees.push(angle);
                cumulativeAngle += angle;
            });

            let randomValue = Math.random() * totalValueActive; 
            let targetEntryId = null; 
            let currentCumulativeValue = 0;
            for (let i = 0; i < activeEntries.length; i++) { 
                currentCumulativeValue += activeEntries[i].value;
                if (randomValue < currentCumulativeValue) {
                    targetEntryId = activeEntries[i].id;
                    break;
                }
            }
            
            // 找到目標區塊在 activeEntries 中的局部索引，用於計算角度
            const targetLocalIndex = activeEntries.findIndex(e => e.id === targetEntryId);


            let targetCenterAngleOfSegment = 0;
            for (let i = 0; i < targetLocalIndex; i++) {
                targetCenterAngleOfSegment += segmentAnglesDegrees[i];
            }
            targetCenterAngleOfSegment += segmentAnglesDegrees[targetLocalIndex] / 2;

            let rotationNeededForAlignment = (360 - targetCenterAngleOfSegment) % 360;
            if (rotationNeededForAlignment < 0) rotationNeededForAlignment += 360;

            let finalRotationDegrees = currentRotationOffset + (spinCount * 360) + rotationNeededForAlignment;

            while (finalRotationDegrees <= currentRotationOffset + 360) {
                finalRotationDegrees += 360;
            }
            
            canvas.style.transition = 'none'; 
            canvas.style.transform = `rotate(${currentRotationOffset}deg)`;
            
            void canvas.offsetWidth; 
            
            const easeOutCubicBezier = 'cubic-bezier(0.1, 0.5, 0, 1)'; 

            canvas.style.setProperty('--spin-duration', `${spinDuration}s`);
            canvas.style.setProperty('--end-rotation', `${finalRotationDegrees}deg`);

            canvas.style.transition = `transform var(--spin-duration) ${easeOutCubicBezier}`;
            canvas.style.transform = `rotate(${finalRotationDegrees}deg)`;

            setTimeout(() => {
                isSpinning = false;
                spinButton.disabled = false;
                
                let actualStopAngle = finalRotationDegrees % 360;
                if (actualStopAngle < 0) actualStopAngle += 360;

                let winningEntryId = null; 
                let pointerRelativeAngle = (360 - actualStopAngle + 360) % 360; 

                for (let i = 0; i < sectorData.length; i++) {
                    const sector = sectorData[i];
                    if (pointerRelativeAngle >= sector.start && pointerRelativeAngle < sector.end) {
                        winningEntryId = sector.originalEntryId;
                        break;
                    }
                }
                
                // 找到中獎區塊在原始 `entries` 中的索引
                const winningEntryOriginalIndex = entries.findIndex(e => e.id === winningEntryId);

                // === 處理卡片效果結束與恢復 ===
                // 先恢復原始狀態
                entries = JSON.parse(JSON.stringify(originalEntriesState));
                drawWheel(); // 繪製恢復後的轉盤

                // 重置卡片 inUse 狀態和相關變數
                cards.boost.inUse = false;
                cards.boost.boostedEntryId = null;
                cards.boost.originalBoostedValue = 0;

                cards.remove.inUse = false;
                cards.remove.removedEntryId = null;
                cards.remove.originalRemovedValue = 0;

                const resultText = entries[winningEntryOriginalIndex].text; 

                highlightSlice(winningEntryOriginalIndex);
                lastHighlightedSliceIndex = winningEntryOriginalIndex;

                // === 處理重啟轉動卡效果 ===
                if (cards.respin.inUse) {
                    finalResultText.textContent = `您抽中了：『${resultText}』！\n是否使用『重啟轉動卡』再轉一次？`;
                    modalConfirmButton.textContent = '再轉一次';
                    modalConfirmButton.onclick = () => {
                        closeModal(); 
                        spinWheel();  
                        cards.respin.inUse = false; // 重啟轉動卡在點擊「再轉一次」後才算完全消耗
                        updateCardUI(); 
                        modalConfirmButton.textContent = '確認'; 
                        modalConfirmButton.onclick = closeModal; 
                    };
                    showResultModal(resultText); 
                } else {
                    showResultModal(resultText);
                    throwConfetti();
                }
                // === 重啟轉動卡效果結束 ===

                currentRotationOffset = actualStopAngle; 
                canvas.style.transform = `rotate(${currentRotationOffset}deg)`;
                canvas.style.transition = 'none'; 
                
                updateCardUI(); // 確保所有卡片按鈕狀態更新
                updateCardTargetSelects(); // 更新下拉選單以反映最新entries
                
            }, spinDuration * 1000); 
        }

        function highlightSlice(index) {
            drawWheel(index);
        }

        function removeHighlight() {
            if (lastHighlightedSliceIndex !== -1) {
                drawWheel();
                lastHighlightedSliceIndex = -1;
            }
        }

        function throwConfetti() {
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800', '#ff5722', '#795548', '#9e9e9e', '#607d8b'];
            const numConfetti = 100;

            for (let i = 0; i < numConfetti; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                confettiContainer.appendChild(confetti);

                confetti.addEventListener('animationend', () => {
                    confetti.remove();
                });
            }
        }

        function showResultModal(resultText) {
            finalResultText.textContent = resultText;
            resultModal.style.display = 'flex';
        }

        function closeModal() {
            resultModal.style.display = 'none';
            modalConfirmButton.textContent = '確認';
            modalConfirmButton.onclick = closeModal;
        }

        // === 卡片功能相關函數 ===

        // 保存當前 entries 的副本作為原始狀態
        function saveOriginalEntriesState() {
            originalEntriesState = JSON.parse(JSON.stringify(entries));
        }

        // 統一更新所有卡片相關的選擇列表
        function updateCardTargetSelects() {
            updateBoostTargetSelect();
            updateRemoveTargetSelect();
        }

        // 更新卡片 UI (數量和按鈕禁用狀態)
        function updateCardUI() {
            respinCardCountSpan.textContent = cards.respin.count;
            boostCardCountSpan.textContent = cards.boost.count;
            removeCardCountSpan.textContent = cards.remove.count;
            
            const respinButton = document.querySelector('#respinCard .card-use-button');
            const boostButton = document.querySelector('#boostCard .card-use-button');
            const removeButton = document.querySelector('#removeCard .card-use-button');

            // 總體禁用邏輯：如果正在旋轉，則禁用所有卡片
            if (isSpinning) {
                respinButton.disabled = true;
                boostButton.disabled = true;
                removeButton.disabled = true;
                return; // 如果正在旋轉，直接返回，不執行後續特定卡片的禁用邏輯
            }

            // 個別卡片禁用邏輯：
            // 1. 卡片數量為 0
            // 2. 有其他卡片正在使用 (防止同時啟用多個效果)
            respinButton.disabled = cards.respin.count === 0 || cards.boost.inUse || cards.remove.inUse;
            boostButton.disabled = cards.boost.count === 0 || cards.respin.inUse || cards.remove.inUse;
            removeButton.disabled = cards.remove.count === 0 || cards.respin.inUse || cards.boost.inUse;
        }

        // 重置所有卡片數量和狀態
        function resetCards() {
            cards.respin.count = 1;
            cards.respin.inUse = false;
            
            cards.boost.count = 1;
            cards.boost.inUse = false;
            cards.boost.boostedEntryId = null;
            cards.boost.originalBoostedValue = 0;
            boostTargetSelectionDiv.style.display = 'none';

            cards.remove.count = 1;
            cards.remove.inUse = false;
            cards.remove.removedEntryId = null;
            cards.remove.originalRemovedValue = 0;
            removeTargetSelectionDiv.style.display = 'none';

            // 將 entries 恢復到最近一次保存的原始狀態 (在任何卡片使用前或在新增/刪除區域後)
            entries = JSON.parse(JSON.stringify(originalEntriesState));
            drawWheel(); 
            updateCardUI(); 
            updateCardTargetSelects(); // 重置後，也更新下拉選單
            alert("所有功能卡片已重置！");
        }


        // --- 重啟轉動卡 ---
        function useRespinCard() {
            if (cards.respin.count > 0 && !isSpinning && !cards.boost.inUse && !cards.remove.inUse) {
                cards.respin.inUse = true;
                cards.respin.count--; // 立即減少卡片數量
                updateCardUI();
                alert("您已使用『重啟轉動卡』，下次轉動後將有機會再轉一次！");
            } else if (cards.respin.count === 0) {
                 alert("『重啟轉動卡』已使用完畢！請點擊『重置卡片』恢復。");
            } else {
                 alert("請等待當前操作結束或轉盤停止，或有其他卡片正在使用。");
            }
        }

        // --- 機率提升卡 ---
        function updateBoostTargetSelect() {
            boostTargetSelect.innerHTML = ''; 
            // 篩選出當前可供選擇的區塊（未被刪除卡移除的）
            const availableEntries = entries.filter(entry => entry.value > 0);
            availableEntries.forEach(entry => {
                const option = document.createElement('option');
                option.value = entry.id;
                option.textContent = entry.text || `區域 ${entry.id.split('-').pop()}`;
                boostTargetSelect.appendChild(option);
            });
            document.querySelector('#boostTargetSelection button:first-of-type').disabled = availableEntries.length === 0;
        }

        function useBoostCard() {
            if (cards.boost.count > 0 && !isSpinning && !cards.respin.inUse && !cards.remove.inUse) {
                const availableEntries = entries.filter(entry => entry.value > 0);
                if (availableEntries.length === 0) {
                    alert("沒有可提升機率的區域，請確認轉盤設定。");
                    return;
                }

                cards.boost.inUse = true;
                cards.boost.count--; // 立即減少卡片數量
                
                boostTargetSelectionDiv.style.display = 'block';
                updateBoostTargetSelect(); 
                updateCardUI(); 
            } else if (cards.boost.count === 0) {
                alert("『機率提升卡』已使用完畢！請點擊『重置卡片』恢復。");
            } else {
                alert("請等待當前操作結束或轉盤停止，或有其他卡片正在使用。");
            }
        }

        function applyBoost() {
            const selectedId = boostTargetSelect.value;
            if (!selectedId) {
                alert("請選擇一個區域來提升機率！");
                return;
            }

            cards.boost.boostedEntryId = selectedId;
            const entry = entries.find(e => e.id === cards.boost.boostedEntryId);
            if (entry) {
                cards.boost.originalBoostedValue = entry.value; // 儲存原始值
                entry.value *= 2; // 提升機率 (倍數可以自訂)
                drawWheel(); 
            }
            
            boostTargetSelectionDiv.style.display = 'none'; 
            updateCardUI(); 
            alert(`您已使用『機率提升卡』，區域 "${entry ? entry.text : '未知'}" 的機率已提升！\n此次旋轉結束後將恢復。`);
        }

        function cancelBoost() {
            // 如果取消，將卡片數量恢復
            if (cards.boost.inUse) {
                cards.boost.count++; 
            }
            cards.boost.inUse = false; 
            if (cards.boost.boostedEntryId && cards.boost.originalBoostedValue > 0) {
                const entry = entries.find(e => e.id === cards.boost.boostedEntryId);
                if (entry) {
                    entry.value = cards.boost.originalBoostedValue; // 恢復原始值
                }
            }
            cards.boost.boostedEntryId = null; 
            cards.boost.originalBoostedValue = 0;
            drawWheel(); 
            boostTargetSelectionDiv.style.display = 'none'; 
            updateCardUI(); 
        }

        // --- 刪除區塊卡 ---
        function updateRemoveTargetSelect() {
            removeTargetSelect.innerHTML = '';
            // 篩選出當前可供選擇的區塊（未被提升卡影響，且非當前被移除的，且確保移除後仍有至少一個可抽獎區塊）
            const availableEntries = entries.filter(entry => {
                // 不能是當前已經被移除的區塊（儘管卡片設計是單次，但以防萬一）
                if (entry.id === cards.remove.removedEntryId) return false;
                // 排除被 boost 提升的區塊，避免衝突
                if (entry.id === cards.boost.boostedEntryId) return false;
                
                // 確保移除後至少還剩下一個 value > 0 的區塊可供抽獎
                const tempEntries = JSON.parse(JSON.stringify(entries)); // 複製一份
                const tempRemovedIndex = tempEntries.findIndex(e => e.id === entry.id);
                if (tempRemovedIndex > -1) {
                    tempEntries[tempRemovedIndex].value = 0; // 模擬移除
                }
                const remainingActive = tempEntries.filter(e => e.value > 0);
                return remainingActive.length > 0;
            });
            
            availableEntries.forEach(entry => {
                const option = document.createElement('option');
                option.value = entry.id;
                option.textContent = entry.text || `區域 ${entry.id.split('-').pop()}`;
                removeTargetSelect.appendChild(option);
            });
            document.querySelector('#removeTargetSelection button:first-of-type').disabled = availableEntries.length === 0;
        }

        function useRemoveCard() {
            if (cards.remove.count > 0 && !isSpinning && !cards.respin.inUse && !cards.boost.inUse) {
                // 確保有足夠的區塊可以移除，至少需要2個活著的區塊
                const activeEntriesCount = entries.filter(e => e.value > 0).length;
                if (activeEntriesCount < 2) {
                    alert("至少需要兩個有效的轉盤區域才能使用『刪除區塊卡』。");
                    return;
                }

                cards.remove.inUse = true;
                cards.remove.count--; // 立即減少卡片數量

                removeTargetSelectionDiv.style.display = 'block';
                updateRemoveTargetSelect(); 
                updateCardUI(); 
            } else if (cards.remove.count === 0) {
                 alert("『刪除區塊卡』已使用完畢！請點擊『重置卡片』恢復。");
            } else {
                 alert("請等待當前操作結束或轉盤停止，或有其他卡片正在使用。");
            }
        }

        function applyRemove() {
            const selectedId = removeTargetSelect.value;
            if (!selectedId) {
                alert("請選擇一個區域來移除！");
                return;
            }

            cards.remove.removedEntryId = selectedId;
            const entry = entries.find(e => e.id === cards.remove.removedEntryId);
            if (entry) {
                cards.remove.originalRemovedValue = entry.value; // 儲存原始值
                entry.value = 0; // 將該區塊的權重設為0，使其不被抽中，也不參與繪製
                drawWheel(); // 重新繪製轉盤，空白區域會消失，其他區域重新分配空間
            }
            
            removeTargetSelectionDiv.style.display = 'none'; 
            updateCardUI(); 
            alert(`您已使用『刪除區塊卡』，區域 "${entry ? entry.text : '未知'}" 已暫時移除！\n此次旋轉結束後將恢復。`);
        }

        function cancelRemove() {
            // 如果取消，將卡片數量恢復
            if (cards.remove.inUse) {
                cards.remove.count++; 
            }
            cards.remove.inUse = false; 
            if (cards.remove.removedEntryId && cards.remove.originalRemovedValue > 0) {
                const entry = entries.find(e => e.id === cards.remove.removedEntryId);
                if (entry) {
                    entry.value = cards.remove.originalRemovedValue; // 恢復原始值
                }
            }
            cards.remove.removedEntryId = null; 
            cards.remove.originalRemovedValue = 0;
            drawWheel(); 
            removeTargetSelectionDiv.style.display = 'none'; 
            updateCardUI(); 
        }

        // === 卡片功能相關函數結束 ===


        // 初始化轉盤區域
        function initializeEntries() {
            entries = []; 
            entriesContainer.innerHTML = ''; 

            addEntry('恭喜發財', 20);
            addEntry('事事順利', 30);
            addEntry('學業進步', 25);
            addEntry('天天開心', 25);
            
            saveOriginalEntriesState(); // 第一次初始化時保存原始狀態
            updateCardUI(); 
        }

        // 事件監聽器
        spinButton.addEventListener('click', spinWheel);

        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && resultModal.style.display === 'flex') {
                closeModal();
            }
        });

        window.addEventListener('click', (event) => {
            if (event.target === resultModal) { 
                closeModal();
            }
        });

        window.addEventListener('resize', () => {
            setCanvasDimensions();
            drawWheel();
            updateCardTargetSelects(); 
        });

        // 頁面加載完成後執行初始化
        window.onload = () => {
            setCanvasDimensions(); 
            initializeEntries(); 
        };
    </script>

</body>
</html>
