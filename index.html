<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自訂轉盤應用程式</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            overflow-x: hidden;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.2em;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            width: 100%;
            max-width: 1000px;
        }

        .panel {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            flex: 1 1 300px;
            min-width: 280px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }

        .wheel-panel {
            flex: 1 1 400px;
            min-width: 350px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        #wheelCanvas {
            width: 100%;
            max-width: 400px;
            height: auto;
            aspect-ratio: 1 / 1; /* 保持正方形 */
            border: 5px solid #3498db;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            background-color: #ecf0f1;
            transform: rotate(0deg); /* 確保一個初始的 transform 值 */
        }

        .spin-button {
            margin-top: 20px;
            padding: 12px 25px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            background-color: #28a745;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .spin-button:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }

        .spin-button:active {
            background-color: #1e7e34;
            transform: translateY(0);
        }

        .spin-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .entry-list {
            margin-top: 15px;
            width: 100%;
        }

        .entry-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            background-color: #f9f9f9;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #eee;
            gap: 8px;
            font-size: 0.95em;
        }

        .entry-item label {
            min-width: 35px;
            font-weight: bold;
            color: #555;
            white-space: nowrap;
        }

        .entry-item input[type="number"] {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 60px;
            max-width: 70px;
        }

        .entry-item input[type="text"] {
            flex: 3;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .entry-item button {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .entry-item button:hover {
            background-color: #c0392b;
        }

        .add-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s ease;
            width: 100%;
        }

        .add-button:hover {
            background-color: #2980b9;
        }

        /* 指針樣式 */
        .pointer {
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-top: 25px solid #e74c3c;
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }

        .settings-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .settings-item {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
        }

        .settings-item label {
            font-weight: bold;
            color: #555;
            min-width: 70px;
        }

        .settings-item input[type="number"] {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 80px;
        }

        /* 彩帶動畫 */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 9999;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: red;
            animation: confetti-fall 3s forwards ease-out;
            opacity: 0;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotateZ(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotateZ(720deg);
                opacity: 0;
            }
        }

        /* 轉盤動畫的CSS */
        #wheelCanvas.spinning {
            /* 調整為一個更平滑的加速和減速曲線，通常是 ease-out 或 custom cubic-bezier */
            /* 這裡使用 ease-out 模擬逐漸減速 */
            transition: transform var(--spin-duration) cubic-bezier(0.25, 0.1, 0.25, 1);
            transform: rotate(var(--end-rotation));
        }
        
        /* 彈出結果視窗 */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            text-align: center;
            position: relative;
            max-width: 90%;
            transform: scale(0.8);
            opacity: 0;
            animation: modal-fade-in 0.3s forwards ease-out;
        }

        @keyframes modal-fade-in {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
        }

        .modal-title {
            font-size: 2.5em;
            color: #28a745;
            margin-bottom: 15px;
        }

        .modal-result-text {
            font-size: 3.5em;
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 25px;
            word-wrap: break-word;
            max-width: 100%;
        }

        .modal-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .modal-button:hover {
            background-color: #2980b9;
        }

        /* 媒體查詢：針對小螢幕設備進一步調整 */
        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
                margin-bottom: 20px;
            }
            .container {
                flex-direction: column;
                gap: 15px;
            }
            .panel {
                padding: 15px;
                flex: 1 1 auto;
                max-height: none;
                overflow-y: visible;
            }
            .wheel-panel {
                min-width: 280px;
            }
            #wheelCanvas {
                max-width: 300px;
            }
            .spin-button {
                padding: 10px 20px;
                font-size: 16px;
            }
            .entry-item {
                font-size: 0.9em;
                padding: 6px 10px;
            }
            .entry-item input[type="number"] {
                width: 50px;
            }
            .pointer {
                border-left: 10px solid transparent;
                border-right: 10px solid transparent;
                border-top: 20px solid #e74c3c;
                top: 10px;
            }
            .modal-content {
                padding: 25px;
            }
            .modal-title {
                font-size: 2em;
            }
            .modal-result-text {
                font-size: 3em;
            }
        }
    </style>
</head>
<body>

    <h1>自訂轉盤應用程式</h1>

    <div class="container">
        <div class="panel controls-panel">
            <h2>轉盤區域設定</h2>
            <div id="entries" class="entry-list">
                </div>
            <button class="add-button" onclick="addEntry()">+ 新增區域</button>

            <div class="settings-section">
                <h2>額外設定</h2>
                <div class="settings-item">
                    <label for="spinCount">旋轉圈數:</label>
                    <input type="number" id="spinCount" value="5" min="1">
                </div>
                <div class="settings-item">
                    <label for="spinDuration">旋轉時間 (秒):</label>
                    <input type="number" id="spinDuration" value="5" min="1" step="0.5">
                </div>
            </div>
        </div>

        <div class="panel wheel-panel">
            <div style="position: relative;">
                <canvas id="wheelCanvas" width="500" height="500"></canvas>
                <div class="pointer"></div>
            </div>
            <button class="spin-button" id="spinButton">旋轉！</button>
        </div>
    </div>

    <div class="confetti-container" id="confettiContainer"></div>

    <div id="resultModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <div class="modal-title">恭喜您！</div>
            <div id="finalResultText" class="modal-result-text"></div>
            <button class="modal-button" onclick="closeModal()">確認</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        let centerX, centerY, radius;

        function setCanvasDimensions() {
            const canvasWidth = canvas.clientWidth;
            const canvasHeight = canvas.clientHeight;

            if (canvas.width !== canvasWidth || canvas.height !== canvasHeight) {
                canvas.width = canvasWidth;
                canvas.height = canvasHeight;
            }
            
            centerX = canvas.width / 2;
            centerY = canvas.height / 2;
            radius = Math.min(centerX, centerY) * 0.8;
        }

        const entriesContainer = document.getElementById('entries');
        const spinButton = document.getElementById('spinButton');
        const spinCountInput = document.getElementById('spinCount');
        const spinDurationInput = document.getElementById('spinDuration');
        const confettiContainer = document.getElementById('confettiContainer');
        const resultModal = document.getElementById('resultModal');
        const finalResultText = document.getElementById('finalResultText');

        let entries = [];
        let isSpinning = false;
        let lastHighlightedSliceIndex = -1;
        let currentRotationOffset = 0; // 追蹤當前累積的旋轉角度偏移

        const colors = [
            '#FF6347', '#4682B4', '#3CB371', '#FFD700', '#DA70D6',
            '#FFA07A', '#6A5ACD', '#7FFFD4', '#CD5C5C', '#F08080',
            '#87CEFA', '#90EE90', '#FFB6C1', '#DDA0DD', '#FFE4B5',
            '#ADD8E6', '#98FB98', '#FFC0CB', '#808000', '#A52A2A'
        ];

        function addEntry(defaultText = '', defaultValue = 10) {
            const index = entries.length;
            const newEntry = {
                value: defaultValue,
                text: defaultText,
                id: `entry-${Date.now()}-${index}`
            };
            entries.push(newEntry);
            renderEntry(newEntry);
            drawWheel();
        }

        function renderEntry(entry) {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'entry-item';
            entryDiv.id = entry.id;

            entryDiv.innerHTML = `
                <label>數值:</label>
                <input type="number" min="1" value="${entry.value}" onchange="updateEntry('${entry.id}', 'value', this.value)">
                <label>文字:</label>
                <input type="text" value="${entry.text}" onchange="updateEntry('${entry.id}', 'text', this.value)">
                <button onclick="removeEntry('${entry.id}')">刪除</button>
            `;
            entriesContainer.appendChild(entryDiv);
        }

        function updateEntry(id, type, value) {
            const entryIndex = entries.findIndex(e => e.id === id);
            if (entryIndex > -1) {
                if (type === 'value') {
                    entries[entryIndex].value = Math.max(1, parseInt(value) || 1);
                } else if (type === 'text') {
                    entries[entryIndex].text = value;
                }
                drawWheel();
            }
        }

        function removeEntry(id) {
            if (entries.length <= 1) {
                alert("至少需要保留一個轉盤區域！");
                return;
            }
            entries = entries.filter(e => e.id !== id);
            document.getElementById(id).remove();
            drawWheel();
        }

        function drawWheel(highlightIndex = -1) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const totalValue = entries.reduce((sum, entry) => sum + entry.value, 0);
            if (totalValue === 0) {
                return;
            }

            let startAngle = -0.5 * Math.PI; // 指針朝上，從-90度開始

            entries.forEach((entry, i) => {
                const angle = (entry.value / totalValue) * Math.PI * 2;
                const color = colors[i % colors.length];

                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, startAngle + angle);
                ctx.closePath();
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();

                if (i === highlightIndex) {
                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, startAngle, startAngle + angle);
                    ctx.closePath();
                    ctx.strokeStyle = 'gold';
                    ctx.lineWidth = 8;
                    ctx.stroke();
                    ctx.restore();
                }

                ctx.save();
                ctx.translate(centerX, centerY);
                
                // **修正2: 文字旋轉 90 度，使其朝下**
                // 原本是旋轉到區塊中心，現在在此基礎上額外旋轉 90 度 (Math.PI / 2)
                ctx.rotate(startAngle + angle / 2 + Math.PI / 2); 
                
                // 由於文字旋轉了，所以 `textAlign` 需要調整
                // 如果文字從圓心向外，旋轉90度後應該是 `center` 或 `left/right`
                // 這裡我們想讓文字在扇形內部居中，所以保持 `center`，但要調整 `fillText` 的 y 軸位置
                ctx.textAlign = "center"; // 文字居中
                ctx.fillStyle = "white";

                let baseFontSize = radius * 0.08;
                let fontSize = Math.min(baseFontSize, 20);

                ctx.font = `bold ${fontSize}px Arial`;
                let textWidth = ctx.measureText(entry.text).width;
                // 調整文字適應邏輯，考慮到現在文字是垂直的
                // 文字長度（寬度）應該適應扇形的高度（半徑 - 扇形內邊距）
                const maxTextLength = radius * 0.6; // 文字距離圓心 0.4 半徑，到邊緣還有 0.6 半徑空間
                while (textWidth > maxTextLength && fontSize > (radius * 0.03)) {
                    fontSize--;
                    ctx.font = `bold ${fontSize}px Arial`;
                    textWidth = ctx.measureText(entry.text).width;
                }
                // 繪製文字，調整位置。現在文字是垂直的，所以 x 保持 0，y 調整為正值（向下）
                // 讓文字從圓心向外，位於扇形的大約中間位置
                ctx.fillText(entry.text, 0, -radius * 0.7); // 調整 Y 軸位置，使其在扇形內部，距離圓心約 0.7 半徑
                ctx.restore();

                startAngle += angle;
            });
        }

        function spinWheel() {
            if (isSpinning) return;

            const totalValue = entries.reduce((sum, entry) => sum + entry.value, 0);
            if (totalValue === 0 || entries.some(entry => entry.value <= 0)) {
                alert("請至少設定一個區域，且所有區域的數值必須大於零！");
                return;
            }

            isSpinning = true;
            spinButton.disabled = true;
            removeHighlight();
            closeModal();

            const spinCount = parseInt(spinCountInput.value) || 5;
            const spinDuration = parseFloat(spinDurationInput.value) || 5;

            const segmentAngles = entries.map(entry => (entry.value / totalValue) * 360);

            let randomValue = Math.random() * totalValue;
            let targetIndex = -1;
            let cumulativeValue = 0;
            for (let i = 0; i < entries.length; i++) {
                cumulativeValue += entries[i].value;
                if (randomValue < cumulativeValue) {
                    targetIndex = i;
                    break;
                }
            }

            let stopAngleDeg = 0;
            for (let i = 0; i < targetIndex; i++) {
                stopAngleDeg += segmentAngles[i];
            }
            stopAngleDeg += segmentAngles[targetIndex] / 2;

            // 計算最終目標旋轉角度 (絕對值)
            const finalRotationDegrees = currentRotationOffset + (spinCount * 360) + (360 - stopAngleDeg);

            // 清除之前的 transition 樣式，並立即設定為當前視覺上的角度
            canvas.style.transition = 'none'; 
            canvas.style.transform = `rotate(${currentRotationOffset}deg)`;
            
            void canvas.offsetWidth; // 強制瀏覽器重繪

            // **修正1: 轉速放慢，使用 cubic-bezier 調整動畫曲線**
            // cubic-bezier(x1, y1, x2, y2)
            // (0, 0) 是開始點，(1, 1) 是結束點。
            // 這裡使用 (0.25, 0.1, 0.25, 1) 是一個常用的 ease-out 曲線，
            // 已經能提供不錯的減速感，但如果需要更明顯的最後一秒減速，可以調整為：
            // 例如：cubic-bezier(0.1, 0.7, 0, 1) 會在結束時減速更劇烈
            // 或者：cubic-bezier(0.1, 0.5, 0, 1)
            // 我這裡維持一個標準的 ease-out (0.25, 0.1, 0.25, 1)，因為它在視覺上通常很流暢。
            // 更精細的最後一秒減速可能需要分段動畫，這會使程式碼更複雜。
            const easeOutCubicBezier = 'cubic-bezier(0.1, 0.5, 0, 1)'; 

            canvas.style.setProperty('--spin-duration', `${spinDuration}s`);
            canvas.style.setProperty('--end-rotation', `${finalRotationDegrees}deg`);

            // 重新添加 transition 屬性，並應用新的動畫曲線
            canvas.style.transition = `transform var(--spin-duration) ${easeOutCubicBezier}`;
            canvas.style.transform = `rotate(${finalRotationDegrees}deg)`;

            // 使用 setTimeout 確保動畫完成後執行邏輯
            setTimeout(() => {
                isSpinning = false;
                spinButton.disabled = false;
                const resultText = entries[targetIndex].text;

                highlightSlice(targetIndex);
                lastHighlightedSliceIndex = targetIndex;

                showResultModal(resultText);
                throwConfetti();

                // 更新當前累積旋轉偏移量
                currentRotationOffset = finalRotationDegrees % 360; 
                if (currentRotationOffset < 0) {
                    currentRotationOffset += 360;
                }
                canvas.style.transform = `rotate(${currentRotationOffset}deg)`;
                canvas.style.transition = 'none'; 
                
            }, spinDuration * 1000);
        }

        function highlightSlice(index) {
            drawWheel(index);
        }

        function removeHighlight() {
            if (lastHighlightedSliceIndex !== -1) {
                drawWheel();
                lastHighlightedSliceIndex = -1;
            }
        }

        function throwConfetti() {
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800', '#ff5722', '#795548', '#9e9e9e', '#607d8b'];
            const numConfetti = 100;

            for (let i = 0; i < numConfetti; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                confettiContainer.appendChild(confetti);

                confetti.addEventListener('animationend', () => {
                    confetti.remove();
                });
            }
        }

        function showResultModal(resultText) {
            finalResultText.textContent = resultText;
            resultModal.style.display = 'flex';
        }

        function closeModal() {
            resultModal.style.display = 'none';
        }

        function initializeEntries() {
            addEntry('恭喜發財', 20);
            addEntry('事事順利', 30);
            addEntry('學業進步', 25);
            addEntry('天天開心', 25);
        }

        spinButton.addEventListener('click', spinWheel);
        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && resultModal.style.display === 'flex') {
                closeModal();
            }
        });
        window.addEventListener('click', (event) => {
            if (event.target === resultModal) {
                closeModal();
            }
        });

        window.addEventListener('resize', () => {
            setCanvasDimensions();
            drawWheel();
        });

        // 頁面加載完成後執行初始化
        window.onload = () => {
            setCanvasDimensions();
            initializeEntries();
        };
    </script>

</body>
</html>
